# R3
# **План R3**
## Подготовительный этап:

1. **Документация по log4j**
    1. Ознакомиться с tutorial - Результат: знаем как подключить библиотеку, как вызвать записть в stdout
    2. Что с конфигурациями? - Результат: знаем как настроить уровни логирования, как сделать запись лога в файл
2. **Документация по H2 Database Engine:**
    1. Как подключить? - Результат: знаем как подключить, как создать подключение к локальной БД из кода
    2. Как заполнить данными? - Результат: знаем как создать таблицы, как наполняем данными (insert? из кода?)
    3. Что такое миграции? - Результат: прочитаны пару статей, напр [https://habr.com/ru/post/121265/](https://habr.com/ru/post/121265/) 
    4. Как сделать миграцию? - Результат: знаем как подготовить тестовые данные в пакет для БД (sql? CSV? backup-file? ) 
    5. Как читать из данные из БД? - Результат: знаем API получения данных из БД
    6. Как писать в БД? - Результат: знаем как сделать комит в БД из кода
3. **Документация flyway:** 
    1. Что нужно для миграции через flyway? : Результат: знаем какой файл заготовить и как вызвать миграцию
4. **SQLI:** 
    1. Что такое? - Результат: знаем как запускаются скрипты и какие обычно бывают(простые)
    2. Как защититься с PreparedStatement? - Результат: знаем, что такое PreparedStatement, как обернуть полученный запрос к БД 

## Реализация требований

1. Добавить `println("Что произошло")` в места принятия решения — R3.1
    1. Успешная аутентификация
    2. Успешная авторизация
    3. Успешный аккаунтинг
    4. Вызов справки
    5. Невалидный формат логина
    6. Неизвестный пользователь
    7. Неправильный пароль
    8. Не известная роль
    9. Нет доступа
    10. Неверная активность
2. Добавить `println` введенных параметров  — R3.1
3. Подключить библиотеку `log4j` — R3.1
    1. Добавить зависимость `jar`
    2. Заменить `println` на  `logger.trace("")` и `logger.error("")`
4. Добавить стандартный конфигурационный файл логгера с настройкой ввывода в файл `aaa.log` — R3.2
5. Перенести работу с данными через СУБД — R3.3
    1. Подключить библиотеку H2
    2. Создать таблицы в [БД](http://www.h2database.com/html/main.html) — R3.4
        1. `CREATE TABLE **USER** (ID INT, LOGIN VARCHAR(10), HASH_PASSWORD(255), SALT(255));`
        2. `CREATE TABLE **ROLE**(ID INT, ROLE_NAME VARCHAR(30));`
        3. `CREATE TABLE **RESOURCE**(ID INT, PATH(VARCHAR(255));`
        4. `CREATE TABLE **USER_RESOURCE**(ID INT, USER_ID INT, RESOURCE_ID INT, ROLE_ID INT);`
        5. `CREATE TABLE **USER_SESSION**(ID INT, USER_ID INT, RESOURCE_ID INT, ROLE_ID INT, START_DATE DATE, END_DATE DATE, VOLUME INT)`
        - PK во всех таблицах — ID, уникальные значения `LOGIN`, `ROLE_NAME`
    3. Заполнить БД тестовыми данными вручную
    4. Написать сервис для работы с БД `DBService` — R3.9
    5. Изменить реализацию методов репозиториев для получения данных из БД — R3.9
        1. `getUserByLogin` из `UserRepository`
        2. `getResourcesByUserLogin` из `ResourceRepository`
6. Подключить `flyway` для работы с миграциями — R3.5
    1. Подключить библиотеку 
    2. Написать скрипты создания таблиц в файлах `.sql` — R3.5
    3. вызвать метод `flyway.migrate()` для инициализации
7. Добавить тестовые данные в миграции — R3.6
    1. Добавить файлы с тестовыми данными в CSV в `/resources `
    2. Написать скрипт миграции с заполнением таблиц из данных в `CSV `
    3. положить файлы в корень проекта `db/migrations`
    4. добавить заполнение данными, если база пуста 
8. Добавить в работу с БД `PreparedStatement` — R3.7, R3.8
9. Отделить модели объектов доменной области от объектов для работы с БД  — R3.11
10. Добавить файл с переменными для подключения к БД: db.env `url= login= pass=` — R3.12